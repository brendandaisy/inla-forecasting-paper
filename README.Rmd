---
title: "Code for: An accurate hierarchical model to forecast diverse seasonal infectious diseases"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This repository contains code to reproduce all materials for the paper "An accurate hierarchical model to forecast diverse seasonal infectious diseases" by Case, Salcedo & Fox.

Scripts for running all the analyses and figures are contained in the `scripts` folder, while core functions for processing data, fitting the model, and making predictions are contained in the `src` folder.

## Summary

The core of the forecasting functionality is separated into four source files:

- `prep-fit-data.R`: take the observed target data and prepare it for model fitting and making forecasts. Does some basic formatting as well as produce `NA` observations for the forecast dates. Also contains some helper functions for producing neighbor matrices from areal shapefiles
- `model-formulas.R`: provides an interface for switching between several variants of the model by choosing different options for the season, short-term main, and short-term interaction effects
- `fit-inla-model.R`: function to fit the model using the workhorse function `inla`. Contains options to calibrate prediction uncertainty and to produce forecasts only for certain locations/horizons
- `sample-forecasts.R`: code to produce forecasts from a fitted model. To ensure accurate representation of the model's predictions, forecasts are produced by sampling from the complete joint distribution over all locations and forecast horizons. Also contains code to produce aggregate (i.e. national) predictions and to summarize sampled forecasts into quantile format.

## Data format

The functionality currently assumes input data in "long" format, containing columns `location`, `date`, `epiweek`. The column containing the response/target data can be sepecified (default is `count`). Additionally, an offset term is used in the model to control for population size, so a column such as `population` containing the size of each location or group should be included. You can set this to 1 throughout if you don't know the population. 

**Note that currently the framework is not fully generalized, and some minor changes to the code would be required to work with a new dataset.** Most of these would probably be in `prep-fit-data.R`.

## Forecasting example

```{r, results='hide', message=F, warning=F}
library(tidyverse)
library(INLA)
library(lubridate)

source("src/prep-fit-data.R")
source("src/model-formulas.R")
source("src/fit-inla-model.R")
source("src/sample-forecasts.R")

inla.setOption(inla.mode="classic")
```


```{r, cache=TRUE}
flu <- read_csv("data/weekly-flu-us.csv") |> 
    filter(date >= "2021-09-01") # exclude peak COVID-19 period

forecast_date <- ymd("2023-12-15") # final date to include in training

# load up a spatial sf object of the US states and convert to neighborhood matrix
graph <- load_us_graph(flu) |> sf2mat()

fit_df <- flu |> 
    filter(location != "US") |> 
    prep_fit_data(forecast_date, weeks_ahead=4, ex_lam=population)

model <- model_formula(seasonal="shared", temporal="ar1", spatial="besagproper")

fit <- fit_inla_model(fit_df, model, graph=graph)

pred_samp <- forecast_samples(fit_df, fit, nsamp=1000)
    
pred_summ <- pred_samp |> 
    summarize_quantiles() |> 
    pivot_wider(names_from=quantile) # wide format for ribbon plots
```

Plot the results compared to truth data:
```{r, cache=TRUE}
# subset of flu data to compare with forecasts
loc_sub <- c("California", "Oregon", "Washington", "Nevada")

flu_sub <- filter(
    flu, 
    date >= (forecast_date - weeks(8)),
    date <= (forecast_date + weeks(4)),
    location %in% loc_sub
)

pred_summ |> 
    filter(location %in% loc_sub) |> 
    ggplot(aes(date)) +
    geom_ribbon(aes(ymin=`0.025`, ymax=`0.975`), fill="skyblue", alpha=0.5, col=NA) +
    geom_ribbon(aes(ymin=`0.25`, ymax=`0.75`), fill="blue1", alpha=0.5, col=NA) +
    geom_line(aes(y=mean), col="blue4") +
    geom_point(aes(y=count), flu_sub, size=0.9) +
    facet_wrap(~location, scales="free_y")
```

### Aggregating forecasts from the joint predictive distribution

Use function `aggregate_forecast` to aggregate forecasts over different locations. By default, this function assumes all locations are to be aggregated into a single group, but additional grouping variables can be passed to produce e.g. regional forecasts instead. In this example, just want national forecasts, i.e. an unweighted sum over all states' predictions.

The optional `tags` argument can be used to label these aggregate forecasts

```{r}
pred_samp_us <- aggregate_forecast(pred_samp, tags=tibble_row(location="US"))
```

The national predictions can simply be added to the state predictions, before or after summarizing, to produce national quantile forecasts:
```{r}
pred_samp |> 
    bind_rows(pred_samp_us) |> 
    summarize_quantiles()
```

The function can also produce totals while removing certain locations/groups by adding new groups to the data. For example, to produce total predictions for just the continental US:
```{r}
outside_loc <- c("Alaska", "Hawaii", "Puerto Rico")

aggregate_forecast(pred_samp, is_continental=!(location %in% outside_loc)) |> 
    filter(is_continental)
```

